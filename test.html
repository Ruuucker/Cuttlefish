<!DOCTYPE html>
<html>
    <head>
        <title>VivaGraphs constant layout demo page</title>
        <script src="libs/vivagraph.js"></script>

        <script type='text/javascript'>
            "use strict";

            function loadJSON(callback, path) {   
              console.log(path);
              var xobj = new XMLHttpRequest();
              xobj.overrideMimeType("application/json");
              xobj.open('GET', path, true);
              xobj.onreadystatechange = function () {
                if (xobj.readyState == 4 && xobj.status == "200") {
                  callback(JSON.parse(xobj.responseText));
                }
              };
              xobj.send(null);  
            }

            function onLoad() {

                /*
                Тут довольно ужасный код, но он принес мне немного боли поэтому пока что оставлю так
                Возможно перейду на
                https://gojs.net/latest/index.html

                TODO Решить баг с первинчым линком на графе
                */

                function drawHops (host) {
                    console.log(host);
                    let prevNode = '127.0.0.1';

                    if (typeof host.trace == 'undefined') {
                        let tmpLocalhost = graph.getNode('127.0.0.1');
                    	// Here i can change the localhost ip
            			tmpLocalhost.nodeId = host.address._attributes.addr;
                    }
                    else {
                        // console.log(host.trace.hop);
                        if (typeof host.trace.hop.length == 'undefined') {
                            // console.log('this is 1 hop');



                            graph.addLink(prevNode, host.trace.hop._attributes.ipaddr);

                            // Пиним ноду
                            let middle = graph.getNode(prevNode);
                            layout.pinNode(middle, true);
                            //prevNode = hop.ipaddr;
                        }
                        else {
                            let hop = host.trace.hop;
                            // Последний хоп это цель, поэтому мы берем оттуда истиное кол-во хопов
                            let ttls = hop[hop.length - 1]._attributes.ttl;
                            let target_ip = host.address._attributes.addr;

                            // Покрывает все ноды кроме последней, из-за этого я дополняю граф последней целевой нодой
                            for (let ttl = 1; ttl < ttls; ttl++) {

                                // Если тру, нода норм
                                // -1 потому что ttl считается с 1, и это сука неудобно
                                if (typeof hop[ttl - 1] != 'undefined' && ttl == hop[ttl - 1]._attributes.ttl) {
                                    graph.addLink(prevNode, hop[ttl - 1]._attributes.ipaddr);
                                    prevNode = hop[ttl - 1]._attributes.ipaddr;

                                } else {
                                    // Просто математический рандом для анонимных нод, потом нужно будет придумать чтонибудь
                                    let tmp = Math.random();
                                    graph.addLink(prevNode, tmp);
                                    prevNode = tmp;
                                }
                                // Пиним ноду
                                // let middle = graph.getNode(prevNode);
                                // layout.pinNode(middle, true);
                                
                            }
                            // Костыль для добавления последней ноды-цели
                            graph.addLink(prevNode, target_ip);
                        }
                    }
                }

                var graph = Viva.Graph.graph();
                var layout = Viva.Graph.Layout.forceDirected(graph, {
                    springLength: 700,
                    springCoeff : 0.00018,
                    gravity : -4000,
                    // This is the main part of this example. We are telling force directed
                    // layout, that we want to change length of each physical spring
                    // by overriding `springTransform` method:
                    springTransform: function (link, spring) {
                      spring.length = 100;
                    }
                });

                var graphics = Viva.Graph.View.svgGraphics(),
                    nodeSize = 20;

                var renderer = Viva.Graph.View.renderer(graph, {
                        layout   : layout,
                        graphics : graphics,
                });

                graphics.node(function(node) {
                  var ui = Viva.Graph.svg('g'),
                      // Create SVG text element with user id as content
                      svgText = Viva.Graph.svg('text').attr('y', '-4px').text(node.id),
                      img = Viva.Graph.svg('image')
                         .attr('width', nodeSize)
                         .attr('height', nodeSize)
                         .link('http://localhost:8080/image');

                    ui.append(svgText);
                    ui.append(img);
                    return ui;

                }).placeNode(function(nodeUI, pos) {
                    nodeUI.attr('transform',
                                'translate(' +
                                      (pos.x - nodeSize/2) + ',' + (pos.y - nodeSize/2) +
                                ')');
                });


                loadJSON(function(arrayOfJSON) {
                    // Тут цикл реквестов всех сканов
                    for (let ni = 0; ni < arrayOfJSON.length; ni++) {
                        loadJSON(function(nmapOutputJSON) {
                            // console.log(nmapOutputJSON);

                            if (typeof nmapOutputJSON.nmaprun.host.length == 'undefined') {
                                let host = nmapOutputJSON.nmaprun.host;
                                drawHops (host);
                            }
                            else {

                                // testMain(nmapOutputJSON.nmaprun.host);
                                graph.addNode('127.0.0.1');
                                for (let i = 0; i < nmapOutputJSON.nmaprun.host.length; i++) {
                                    // console.log(nmapOutputJSON.nmaprun.host[i]);
                                    // nmapOutputJSON[i]
                                    let host = nmapOutputJSON.nmaprun.host[i];
                                    drawHops (host);
                                }
                            }
                        }, arrayOfJSON[ni]);
                    }

                }, '/test');

                renderer.run();
            }


        </script>

        <style type="text/css" media="screen">
            body, html, svg { width: 100%; height: 100%; overflow: hidden; }
        </style>
    </head>
    <body onload="onLoad()">

    </body>
</html>
